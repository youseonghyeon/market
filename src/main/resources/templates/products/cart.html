<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/header::header"></head>
<script th:inline="javascript">

    $(document).ready(function () {
        $(":checkbox").change(function () {
            getCurrentData();
        })
    })

    const purchase = () => {
        let str = "";
        let elems = document.getElementsByClassName("check_buttons");
        for (const elem of elems) {
            if (elem.checked) {
                str += elem.value + ",";
            }
        }
        $('#input_items').val(str);
        $('#form_submit').submit();
    }

    const deleteCart = (cartId) => {
        $.ajax({
            url: "/cart",
            method: "DELETE",
            data: {
                cartId
            },
            beforeSend: function (xhr) {
                xhr.setRequestHeader(getCsrfHeader(), getCsrfToken())
            }
        }).done(function (result, status) {
            $("#cart" + cartId).remove();
            getCurrentData();
        })
    }

    const deleteAll = () => {
        let token = $("meta[name='_csrf']").attr("content");
        let header = $("meta[name='_csrf_header']").attr("content");
        $.ajax({
            url: "/cart/all",
            method: "DELETE",
            beforeSend: function (xhr) {
                xhr.setRequestHeader(header, token)
            }
        }).done(function (result, status) {
            $('.eachCart').remove()
            getCurrentData();
        })
    }

    const modifyQuantity = (cartId) => {
        let quantity = $('#quantity' + cartId).val();
        let token = $("meta[name='_csrf']").attr("content");
        let header = $("meta[name='_csrf_header']").attr("content");

        $.ajax({
            url: "/cart/quantity",
            method: "POST",
            data: {
                cartId,
                quantity
            },
            beforeSend: function (xhr) {
                xhr.setRequestHeader(header, token)
            }
        }).done(function (res) {
            $("#price" + cartId).text(res);
            getCurrentData()
        })
    }

    const getCurrentData = () => {
        let checkButtons = $(".check_buttons");
        let data = "";
        for (const check of checkButtons) {
            if (check.checked) {
                data += check.value + ",";
            }
        }
        $.ajax({
            url: "/cart/refetch",
            method: "GET",
            data: {
                cartIdList: data,
            },
        }).done(function (res) {
            $("#shippingFee").text(res.shippingFee);
            $("#totalPrice").text(res.totalPrice);
        })
    }


</script>
<body>
<nav th:replace="fragments/nav::main-nav"></nav>
<div class="container" style="padding-right: 200px; padding-left: 200px;">
    <div class="bg-white shadow" style="padding-right: 30px; padding-left: 30px; padding-top: 20px; margin-top: 40px;">
        <div class="d-flex justify-content-between align-items-end">
            <div class="fs-3 mt-4 fw-bold">장바구니</div>
            <button class="btn btn-danger" onclick="deleteAll()">전체삭제</button>
        </div>
        <div class="d-flex justify-content-center align-items-center" th:if="${cartList.isEmpty()}"
             style="min-height: 500px;">
            <div class="d-flex flex-column aic">
                <span class="material-icons-outlined md-48">info</span>
                <div class="fs-5 mt-3">장바구니에 상품이 없어요 ㅠㅠ</div>
                <a th:href="@{/product}" class="btn btn-custom">상품 보러가기</a>
            </div>
        </div>


        <div class="mt-3" th:unless="${cartList.isEmpty()}">
            <table class="table">
                <tr>
                    <td>전체선택</td>
                    <td>상품정보</td>
                    <td>수량</td>
                    <td>상품금액</td>
                    <td style="width: 30px;"></td>
                </tr>
                <tr th:id="'cart' + ${cart.getId()}" class="eachCart" th:each="cart : ${cartList}">
                    <td><input class="check_buttons" th:value="${cart.getId()}" type="checkbox" checked></td>
                    <td >
                        <span th:text="${cart.getItem().getName()}"></span>
                        <span th:if="${cart.getOptions()}" th:text="${'(' + cart.getOptions() + ')'}"></span>
                    </td>
                    <td>
                        <input th:id="${'quantity' + cart.getId()}" th:onfocusout="|modifyQuantity(${cart.getId()})|"
                               style="width: 50px;" type="number" th:value="${cart.getQuantity()}">
                    </td>
                    <td>
                        <span th:id="'price' + ${cart.getId()}" th:text="${cart.getPrice()}"></span>
                        <span>원</span>
                    </td>
                    <td>
                        <button th:onclick="deleteCart([[${cart.getId()}]])">
                            <span class="material-icons-outlined">close</span>
                        </button>
                    </td>
                </tr>
            </table>
            <div class="border-bottom border-gray d-flex justify-content-between mt-4" style="padding-right: 150px;">
                <div>배송비</div>
                <div>
                    <span id="shippingFee" th:text="${shippingFee}">0000(배송비)</span>
                    <span>원</span>
                </div>
            </div>
            <div class="border-bottom border-gray d-flex justify-content-between mt-4" style="padding-right: 150px;">
                <div>합계</div>
                <div>
                    <span id="totalPrice" th:text="${totalPrice}">총 금액</span>
                    <span>원</span>
                </div>
            </div>

            <div onclick="purchase()" class="btn btn-custom mt-5">구매하기</div>
            <div style="height: 200px;"></div>
            <form id="form_submit" th:action="@{/purchase}" method="GET">
                <input id="input_items" type="hidden" name="items">
            </form>
        </div>

    </div>
</div>
<footer th:replace="fragments/footer::footer"></footer>
</body>


</html>
